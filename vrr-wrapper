#!/usr/bin/env bash
set -e

VRR_OUTPUT=2
SERVICES_TO_MANAGE=(
    "docker"
)

declare -A ORIGINAL_SERVICE_STATES

disable_vrr() {
    kscreen-doctor output."$VRR_OUTPUT".vrrpolicy.never
    echo "VRR disabled"
}

enable_vrr() {
    kscreen-doctor output."$VRR_OUTPUT".vrrpolicy.automatic
    echo "VRR restored"
}

disable_services() {
    for svc in "${SERVICES_TO_MANAGE[@]}"; do
        if systemctl is-active --quiet "$svc"; then
            ORIGINAL_SERVICE_STATES[$svc]="active"
            echo "Stopping $svc (force if necessary)..."
            sudo systemctl stop "$svc" --no-block || true
            sleep 1
            if systemctl is-active --quiet "$svc"; then
                echo "$svc did not stop, killing processes..."
                sudo systemctl kill "$svc" || true
            fi
        else
            ORIGINAL_SERVICE_STATES[$svc]="inactive"
        fi
    done
}

restore_services() {
    for svc in "${SERVICES_TO_MANAGE[@]}"; do
        if [[ "${ORIGINAL_SERVICE_STATES[$svc]}" == "active" ]]; then
            echo "Restoring $svc..."
            sudo systemctl start "$svc" || true
        fi
    done
}

cleanup() {
    enable_vrr
    restore_services
}
trap cleanup EXIT INT TERM

# Run prep
disable_vrr
disable_services

# Run the game as normal user (foreground)
echo "Starting game..."
"$@"
